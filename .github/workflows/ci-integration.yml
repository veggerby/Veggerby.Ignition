name: Integration Tests

on:
  pull_request:
    branches: [ main ]
    types: [opened, reopened, synchronize, ready_for_review, labeled]
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter (e.g., Category=Integration or FullyQualifiedName~Kafka)'
        required: false
        default: 'Category=Integration&SkipInCI!=true'
        type: string

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  # TESTCONTAINERS_HOST_OVERRIDE: host.docker.internal

jobs:
  # Discover all integration packages and generate dynamic configuration
  discover-packages:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.discover.outputs.packages }}
      package-count: ${{ steps.discover.outputs.package-count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Discover integration packages
        id: discover
        run: |
          echo "Discovering integration packages..."
          
          # Find all integration packages (exclude core and metrics)
          PACKAGES=$(find src -maxdepth 1 -type d -name 'Veggerby.Ignition.*' ! -name 'Veggerby.Ignition.Metrics.*' -exec basename {} \; | sed 's/Veggerby.Ignition.//g' | sort)
          
          # Build JSON array for matrix
          JSON_ARRAY="["
          FIRST=true
          for pkg in $PACKAGES; do
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              JSON_ARRAY="$JSON_ARRAY,"
            fi
            # Convert to lowercase for filter names
            FILTER_NAME=$(echo "$pkg" | tr '[:upper:]' '[:lower:]')
            JSON_ARRAY="$JSON_ARRAY{\"name\":\"$pkg\",\"filter\":\"$FILTER_NAME\",\"project\":\"Veggerby.Ignition.$pkg.Tests\"}"
          done
          JSON_ARRAY="$JSON_ARRAY]"
          
          echo "packages=$JSON_ARRAY" >> $GITHUB_OUTPUT
          echo "package-count=$(echo $PACKAGES | wc -w)" >> $GITHUB_OUTPUT
          
          echo "✅ Discovered $(echo $PACKAGES | wc -w) integration packages"
          echo "Packages: $PACKAGES"

      - name: Generate paths-filter configuration
        id: generate-filters
        run: |
          echo "Generating dynamic paths-filter configuration..."
          
          # Create filter config file
          cat > /tmp/filters.yml << 'EOF'
          core:
            - 'src/Veggerby.Ignition/**'
            - 'test/Veggerby.Ignition.Tests/**'
          EOF
          
          # Add each integration package
          PACKAGES=$(find src -maxdepth 1 -type d -name 'Veggerby.Ignition.*' ! -name 'Veggerby.Ignition.Metrics.*' -exec basename {} \; | sed 's/Veggerby.Ignition.//g' | sort)
          for pkg in $PACKAGES; do
            FILTER_NAME=$(echo "$pkg" | tr '[:upper:]' '[:lower:]')
            cat >> /tmp/filters.yml << EOF
          ${FILTER_NAME}:
            - 'src/Veggerby.Ignition.${pkg}/**'
            - 'test/Veggerby.Ignition.${pkg}.Tests/**'
          EOF
          done
          
          echo "Filter configuration generated:"
          cat /tmp/filters.yml

      - name: Upload filter configuration
        uses: actions/upload-artifact@v4
        with:
          name: filter-config
          path: /tmp/filters.yml
          retention-days: 1

  # Detect which integration test projects need to run based on changed files
  detect-changes:
    needs: discover-packages
    runs-on: ubuntu-latest
    outputs:
      run-all: ${{ steps.detect.outputs.run-all }}
      changed-filters: ${{ steps.detect.outputs.changed-filters }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download filter configuration
        uses: actions/download-artifact@v4
        with:
          name: filter-config
          path: /tmp

      - uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name == 'pull_request'
        with:
          filters: /tmp/filters.yml

      - name: Determine test scope
        id: detect
        run: |
          # Run all tests if: manual trigger, push to main, label present, or core package changed
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || \
             [[ "${{ github.event_name }}" == "push" ]] || \
             [[ "${{ contains(github.event.pull_request.labels.*.name, 'run-integration-tests') }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.core }}" == "true" ]]; then
            echo "run-all=true" >> $GITHUB_OUTPUT
            echo "changed-filters=all" >> $GITHUB_OUTPUT
          else
            echo "run-all=false" >> $GITHUB_OUTPUT
            # Get list of changed filters (excluding 'core')
            CHANGED=$(cat << 'EOF' | jq -r 'to_entries | map(select(.value == "true" and .key != "core")) | map(.key) | join(",")'
          ${{ toJSON(steps.filter.outputs) }}
          EOF
          )
            echo "changed-filters=$CHANGED" >> $GITHUB_OUTPUT
            echo "Changed packages: $CHANGED"
          fi

  # Build once, run tests as matrix
  build:
    runs-on: ubuntu-latest
    needs: [discover-packages, detect-changes]
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore Veggerby.Ignition.sln

      - name: Build
        run: dotnet build Veggerby.Ignition.sln --configuration Release --no-restore

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            src/**/bin/Release/**
            test/**/bin/Release/**
          retention-days: 1

  # Run integration tests for each package
  integration-tests:
    runs-on: ubuntu-latest
    needs: [discover-packages, detect-changes, build]
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJSON(needs.discover-packages.outputs.packages) }}

    name: Test ${{ matrix.package.name }}
    
    steps:
      - name: Check if package should run
        id: should-run
        run: |
          RUN_ALL="${{ needs.detect-changes.outputs.run-all }}"
          CHANGED="${{ needs.detect-changes.outputs.changed-filters }}"
          FILTER="${{ matrix.package.filter }}"
          
          if [[ "$RUN_ALL" == "true" ]] || [[ "$CHANGED" == "all" ]] || [[ ",$CHANGED," == *",$FILTER,"* ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
            echo "✅ Running tests for ${{ matrix.package.name }}"
          else
            echo "run=false" >> $GITHUB_OUTPUT
            echo "⏭️ Skipping ${{ matrix.package.name }} - no changes detected"
          fi

      - uses: actions/checkout@v4
        if: steps.should-run.outputs.run == 'true'

      - name: Setup .NET
        if: steps.should-run.outputs.run == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Download build artifacts
        if: steps.should-run.outputs.run == 'true'
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Restore dependencies
        if: steps.should-run.outputs.run == 'true'
        run: dotnet restore test/${{ matrix.package.project }}/${{ matrix.package.project }}.csproj

      - name: Build ${{ matrix.package.name }} test project
        if: steps.should-run.outputs.run == 'true'
        run: dotnet build test/${{ matrix.package.project }}/${{ matrix.package.project }}.csproj --configuration Release --no-restore

      - name: Run ${{ matrix.package.name }} Integration Tests
        if: steps.should-run.outputs.run == 'true'
        run: |
          dotnet test test/${{ matrix.package.project }}/${{ matrix.package.project }}.csproj \
            --configuration Release \
            --no-build \
            --filter "Category=Integration&SkipInCI!=true" \
            --logger "console;verbosity=normal"

      - name: Upload test results for ${{ matrix.package.name }}
        if: always() && steps.should-run.outputs.run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ matrix.package.name }}
          path: |
            test/${{ matrix.package.project }}/TestResults/**/*.trx
            test/${{ matrix.package.project }}/TestResults/**/*.xml
          retention-days: 30

  # Summary job that's required for branch protection
  integration-summary:
    runs-on: ubuntu-latest
    needs: [discover-packages, detect-changes, integration-tests]
    if: always()
    steps:
      - name: Generate test summary
        run: |
          echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine run mode
          RUN_ALL="${{ needs.detect-changes.outputs.run-all }}"
          CHANGED="${{ needs.detect-changes.outputs.changed-filters }}"
          
          if [[ "$RUN_ALL" == "true" ]]; then
            echo "**Mode:** Full suite (all ${{ needs.discover-packages.outputs.package-count }} packages)" >> $GITHUB_STEP_SUMMARY
          else
            CHANGED_COUNT=$(echo "$CHANGED" | tr ',' '\n' | grep -v '^$' | wc -l)
            echo "**Mode:** Selective ($CHANGED_COUNT changed package(s))" >> $GITHUB_STEP_SUMMARY
            if [[ -n "$CHANGED" && "$CHANGED" != "all" ]]; then
              echo "**Changed:** $CHANGED" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create status table
          echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Parse package matrix and show status
          PACKAGES='${{ needs.discover-packages.outputs.packages }}'
          echo "$PACKAGES" | jq -r '.[] | "\(.name) \(.filter)"' | while read NAME FILTER; do
            if [[ "$RUN_ALL" == "true" ]] || [[ "$CHANGED" == "all" ]] || [[ ",$CHANGED," == *",$FILTER,"* ]]; then
              echo "| $NAME | ✅ Tested |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $NAME | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check test results
        run: |
          if [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "## ❌ Integration Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more integration test packages failed. Review the logs above for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [[ "${{ needs.integration-tests.result }}" == "cancelled" ]]; then
            echo "## ⚠️ Integration Tests Cancelled" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The integration test run was cancelled before completion." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ✅ All Integration Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All required integration tests completed successfully!" >> $GITHUB_STEP_SUMMARY
          fi
